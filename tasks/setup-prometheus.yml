---

- name: "Set Binary url"
  set_fact:
    prometheus_binary_url: "{{ __prometheus_bin_url }}/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.{{ prometheus_platform_suffix }}.tar.gz"

- name: "Ensure Prometheus binary exists"
  stat:
    path: "{{ prometheus_path_install }}/prometheus-{{ prometheus_version }}.{{ prometheus_platform_suffix }}/prometheus"
  register: prometheus_binary_stat

- name: "Download and expand Prometheus binaries"
  unarchive:
    src: "{{ prometheus_binary_url }}"
    dest: "{{ prometheus_path_install }}"
    copy: no
  when: not prometheus_binary_stat.stat.exists

- name: "Ensure files permissions"
  file:
    path: "{{ prometheus_path_install }}"
    state: directory
    recurse: yes
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "go-w"

- name: "Create Prometheus directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "u=rwx,g=rx,o="
  with_items:
    - "{{ prometheus_path_db }}"
    - "{{ prometheus_path_rules }}"
    - "{{ prometheus_path_file_sd_config }}"

- name: "Ensure Prometheus systemd's unit file exists"
  template:
    src: "prometheus.service.j2"
    dest: "/etc/systemd/system/{{ prometheus_service_name }}.service"
  register: prometheus_service_changed

- name: "Ensure systemd daemon reload"
  systemd:
    name: "{{ prometheus_service_name }}"
    daemon_reload: yes
  when: prometheus_service_changed.changed == True

- name: "Ensure Prometheus Server systemd service run at boot time"
  systemd:
    name: "{{ prometheus_service_name }}"
    enabled: yes
  notify:
    - "restart prometheus service"

- name: "Ensure Prometheus configuration"
  template:
    src: "prometheus.yml.j2"
    dest: "{{ prometheus_path_config }}/prometheus.yml"
    owner: "{{ prometheus_user }}"
    group: "{{ prometheus_group }}"
    mode: "u=rw,g=,o="
  notify:
      - "restart prometheus service"
